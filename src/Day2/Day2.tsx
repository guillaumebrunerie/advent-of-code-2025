import { useMemo } from "react";
import { Sequence, interpolate, useVideoConfig } from "remotion";

import { DayWrapperShorts } from "../Shorts/DayWrapperShorts";
import { Rectangle } from "../common/Rectangle";
import { range } from "../common/range";
import { useCurrentTime } from "../common/useCurrentTime";
import { widthShorts } from "../constants";
import { raw } from "./raw";

// const raw =
// 	"11-22,95-115,998-1012,1188511880-1188511890,222220-222224,1698522-1698528,446443-446449,38593856-38593862,565653-565659,824824821-824824827,2121212118-2121212124";

const solve = () => {
	const ranges = raw
		.split(",")
		.map((range) => range.split("-").map((n) => parseInt(n, 10)))
		.map(([start, end]) => ({
			start,
			end,
			ids1: [] as { id: number; repetitions: number; time: number }[],
			ids2: [] as { id: number; repetitions: number; time: number }[],
		}));
	let part1 = 0;
	let part2 = 0;
	const counted = new Set<number>();
	for (const range of ranges) {
		const { start, end, ids1, ids2 } = range;
		const startStr = start.toString();
		const endStr = end.toString();
		for (let repetitions = endStr.length; repetitions >= 2; repetitions--) {
			const min =
				startStr.length % repetitions == 0 ?
					Number(startStr.slice(0, startStr.length / repetitions))
				:	Math.pow(10, Math.floor(startStr.length / repetitions));
			let idPart = min;
			while (true) {
				const idStr = idPart.toString().repeat(repetitions);
				const id = Number(idStr);
				if (id > end) {
					break;
				}
				if (id < start) {
					idPart++;
					continue;
				}
				if (counted.has(id)) {
					idPart++;
					continue;
				}
				counted.add(id);
				const time = (id - start) / (end - start);
				if (repetitions == 2) {
					part1 += id;
					ids1.push({ id, repetitions, time });
				}
				part2 += id;
				ids2.push({ id, repetitions, time });
				idPart++;
			}
		}
	}
	console.log("Part 1:", part1);
	console.log("Part 2:", part2);
	return ranges;
};

const Page = ({
	data,
	isPart1,
}: {
	data: ReturnType<typeof solve>[number];
	isPart1: boolean;
}) => {
	const ids = isPart1 ? data.ids1 : data.ids2;
	const time = useCurrentTime();
	const timeStart =
		ids.length < 2 ? 0.5
		: ids.length < 4 ? 0.25
		: ids.length < 8 ? 0.125
		: 0.125 / 2;
	const timeOffset = timeStart;
	const currentValue = Math.floor(
		data.start + time * (data.end - data.start),
	);
	const y1 = 250;
	const y2 = 330;
	const y3 = 450;
	return (
		<>
			<Rectangle cx y={y1} style={{ fontSize: 60, color: "#FFF" }}>
				{data.start}-{data.end}
			</Rectangle>
			<Rectangle cx y={y2} style={{ fontSize: 60 }}>
				{currentValue}
			</Rectangle>
			{ids
				.toSorted((a, b) => a.id - b.id)
				.map(({ id, repetitions }, i) => {
					const str = id.toString();
					const halfStr = str.slice(0, str.length / repetitions);
					const widthDigit = 36;
					const widthSpace = 3;
					const widthNumber =
						str.length * widthDigit +
						(repetitions - 1) * widthSpace;
					const barSpacing = halfStr.length * widthDigit + widthSpace;
					// if (time < timeStart + i * timeOffset) {
					if (id > currentValue) {
						return null;
					}
					const lines = ids.filter(
						({ id }) => id < currentValue,
					).length;
					const yOffset = lines <= 15 ? 0 : (lines - 15) * 80;
					if (i < lines - 15) {
						return null;
					}
					const visualI = lines <= 15 ? i : i - (lines - 15);
					const opacity = 1 / (1 + Math.exp(1 * (visualI - 13)));
					return (
						<>
							<Rectangle
								key={i}
								cx
								y={y3 + i * 80 - yOffset}
								style={{
									fontSize: 60,
									opacity,
								}}
							>
								{Array(repetitions)
									.fill(halfStr)
									.join("\u200A")}
							</Rectangle>
							{range(1, repetitions).map((j) => (
								<Rectangle
									key={j}
									cx
									x={
										widthShorts / 2 -
										widthNumber / 2 +
										j * barSpacing -
										widthSpace / 2
									}
									y={y3 + i * 80 - yOffset}
									w={5}
									h={80}
									style={{
										backgroundColor: "#0C0",
										opacity,
									}}
								/>
							))}
						</>
					);
				})}
		</>
	);
};

export const Day2Short = () => {
	const { fps } = useVideoConfig();
	const data = useMemo(solve, []);
	console.log(
		"$: note(`<\n" +
			data
				.slice(0, 16)
				.map((l, i) => {
					const ids = (i < 8 ? l.ids1 : l.ids2).sort(
						(a, b) => a.id - b.id,
					);
					if (ids.length == 0) {
						return "<[~@1]>";
					}
					const pauseDuration = ids[0].time;
					return (
						`<[~@${pauseDuration} ` +
						ids
							.map(({ id, repetitions, time }, j) => {
								const duration =
									(j == ids.length - 1 ?
										1
									:	ids[j + 1].time) - time;
								return `c${2 + repetitions}@${duration}`;
							})
							.join(" ") +
						"]>"
					);
				})
				.join("\n") +
			'\n>`).sound("sine").attack(0).decay(0.1);',
	);
	return (
		<DayWrapperShorts day={2} title="Gift Shop" dayDuration={16}>
			{data.map((d, i) => (
				<Sequence from={i * fps} durationInFrames={1 * fps}>
					<Page data={d} isPart1={i < 8} />
				</Sequence>
			))}
			{/* {data.map((d, i) => <Sequence></Sequence>)} */}
		</DayWrapperShorts>
	);
};
Day2Short.duration = 16;

/**
setcps(1)

$: s("lt").gain("<1.5 1>").slow(8)

$: s("bd").gain(0.5)

$: note(`<
<[~@1]>
<[~@0.5707371671169432 c4@0.4292628328830568]>
<[~@0.5454136840352921 c4@0.4545863159647079]>
<[~@0.008501383946223804 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.01996836694345592 c4@0.03993673388691181 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.019968366943455912 c4@0.01996836694345594 c4@0.019968366943455884 c4@0.039936733886911824 c4@0.01996836694345594 c4@0.019968366943455884 c4@0.019968366943455884 c4@0.01996836694345594 c4@0.019968366943455884 c4@0.01996836694345594 c4@0.019968366943455884 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.03993673388691177 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345583 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345583 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.03993673388691177 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345583 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345594 c4@0.01996836694345583 c4@0.01996836694345594 c4@0.052985369711348373]>
<[~@1]>
<[~@0.015799746782021524 c4@0.02640324963072378 c4@0.026403249630723782 c4@0.026403249630723782 c4@0.026403249630723782 c4@0.026403249630723782 c4@0.02640324963072377 c4@0.026403249630723796 c4@0.02640324963072377 c4@0.02640324963072377 c4@0.026403249630723824 c4@0.02640324963072377 c4@0.02640324963072377 c4@0.02640324963072377 c4@0.026403249630723824 c4@0.02640324963072377 c4@0.02640324963072377 c4@0.05280649926144754 c4@0.02640324963072377 c4@0.026403249630723824 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.026403249630723824 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.026403249630723824 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.026403249630723824 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.026403249630723824 c4@0.026403249630723713 c4@0.007280016881198614]>
<[~@1]>
<[~@0.007946312310106507 c4@0.011140418238678732 c4@0.011140418238678729 c4@0.011140418238678732 c4@0.011140418238678729 c4@0.011140418238678736 c4@0.022280836477357457 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678743 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678756 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678784 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678673 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.01114041823867884 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.011140418238678729 c4@0.0005564644474864711]>
<[~@0.04654559484112768 c7@0.3061978118885551 c7@0.30619781188855516 c7@0.3061978118885551 c7@0.03486096949320694]>
<[~@0.0004902809021168599 c4@0.009622964372921114 c4@0.0017496298859856572 c5@0.007873334486935456 c4@0.009622964372921112 c4@0.009622964372921112 c4@0.009622964372921115 c4@0.009622964372921108 c4@0.009622964372921115 c4@0.009622964372921108 c4@0.009622964372921122 c4@0.009622964372921108 c4@0.009622964372921108 c4@0.0026244448289784866 c5@0.006998519543942636 c4@0.009622964372921095 c4@0.009622964372921122 c4@0.009622964372921122 c4@0.009622964372921095 c4@0.009622964372921122 c4@0.009622964372921122 c4@0.009622964372921095 c4@0.009622964372921122 c4@0.009622964372921122 c4@0.003499259771971297 c5@0.0061237046009497975 c4@0.009622964372921122 c4@0.009622964372921122 c4@0.009622964372921095 c4@0.009622964372921122 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.004374074714964149 c5@0.0052488896579569455 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.0052488896579569455 c5@0.004374074714964149 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.00962296437292115 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.0061237046009497975 c5@0.003499259771971297 c4@0.009622964372921095 c4@0.009622964372921206 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921206 c4@0.009622964372921095 c4@0.006998519543942594 c5@0.0026244448289785005 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921206 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.007873334486935502 c5@0.001749629885985704 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921206 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.008748149429928298 c5@0.0008748149429927965 c4@0.009622964372921095 c4@0.009622964372921206 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921095 c4@0.009622964372921206 c4@0.009622964372921095 c4@0.009622964372921095 c8@0.11419699678914075]>
<[~@0.6311475409836066 c5@0.3688524590163934]>
<[~@0.002319911340967861 c4@0.014791281861839674 c4@0.004033985962319912 c5@0.010757295899519764 c4@0.014791281861839672 c4@0.01479128186183968 c4@0.014791281861839672 c4@0.014791281861839672 c4@0.014791281861839672 c4@0.014791281861839686 c4@0.014791281861839659 c4@0.014791281861839672 c4@0.0147912818618397 c4@0.005378647949759868 c5@0.009412633912079804 c4@0.014791281861839672 c4@0.014791281861839672 c4@0.014791281861839672 c4@0.014791281861839672 c4@0.014791281861839672 c4@0.0147912818618397 c4@0.014791281861839645 c4@0.0147912818618397 c4@0.014791281861839645 c4@0.006723309937199884 c5@0.008067971924639816 c4@0.014791281861839645 c4@0.0147912818618397 c4@0.014791281861839645 c4@0.0147912818618397 c4@0.0147912818618397 c4@0.014791281861839645 c4@0.0147912818618397 c4@0.014791281861839645 c4@0.0147912818618397 c4@0.008067971924639816 c5@0.006723309937199828 c4@0.0147912818618397 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.009412633912079804 c5@0.0053786479497598405 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.010757295899519792 c5@0.004033985962319853 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.012101957886959669 c5@0.0026893239748799758 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.014791281861839756 c4@0.014791281861839645 c4@0.014791281861839645 c4@0.006664203915773936]>
<[~@0.15569929307382566 c4@0.2901429278126778 c7@0.2417857731772316 c4@0.3123720059362649]>
<[~@0.5555555555555556 c4@0.4444444444444444]>
<[~@0.6475906172226613 c5@0.3524093827773387]>
<[~@0.06893717774364293 c4@0.09784852605934898 c4@0.09784852605934896 c4@0.09784852605934902 c6@0.09784852605934896 c4@0.09784852605934896 c4@0.09784852605934902 c4@0.09784852605934902 c4@0.0978485260593489 c4@0.09784852605934902 c4@0.05042608772221624]>
>`).sound("sine").attack(0).decay(0.1);
 */
